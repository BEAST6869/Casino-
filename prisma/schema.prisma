generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Models adapted for MongoDB (ObjectId fields).

model User {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  discordId   String @unique
  username    String

  wallet      Wallet?
  bank        Bank?

  creditScore Int @default(500)
  
  // User preferences
  profileTheme String @default("cyberpunk") 

  bets        Bet[]
  inventory   Inventory[] // Relation to Inventory items
  
  lastDaily   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Leveling
  xp          Int      @default(0)
  level       Int      @default(0)

  // Ban System
  isBanned    Boolean  @default(false)
}

model Wallet {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  user         User          @relation(fields: [userId], references: [id])
  userId       String        @unique @db.ObjectId
  balance      Int           @default(0)
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Transaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  wallet    Wallet   @relation(fields: [walletId], references: [id])
  walletId  String   @db.ObjectId
  amount    Int
  type      String   // e.g.: income, admin_add, wallet_to_bank, bank_to_wallet, bet, payout, transfer_sent, transfer_recv
  meta      Json?
  isEarned  Boolean? @default(false)
  createdAt DateTime @default(now())
}

model GameSession {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  type      String // e.g. "roulette", "slots", "blackjack"
  bets      Bet[]
  createdAt DateTime @default(now())
}

model Bet {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  user      User        @relation(fields: [userId], references: [id])
  userId    String      @db.ObjectId
  game      GameSession @relation(fields: [gameId], references: [id])
  gameId    String      @db.ObjectId
  amount    Int
  choice    String?
  result    String?
  payout    Int?
  createdAt DateTime    @default(now())
}

model RoleIncome {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  guildId   String
  roleId    String
  amount    Int 
  interval  Int 
  lastClaim DateTime?
  createdAt DateTime  @default(now())
}

model Job {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  guildId     String
  key         String @unique
  name        String
  minPay      Int
  maxPay      Int
  successRate Float?
  cooldown    Int
}

model ShopItem {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId      String
  name         String
  description  String   @default("No description")
  price        Int
  stock        Int      @default(-1) // -1 = unlimited
  roleId       String?  
  
  // Relations
  inventory    Inventory[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// FIX: Added 'user' relation field to match 'inventory' in User model
model Inventory {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId     String
  
  // This relation connects back to the User model
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @db.ObjectId
  
  shopItem    ShopItem @relation(fields: [shopItemId], references: [id], onDelete: Cascade)
  shopItemId  String   @db.ObjectId
  
  amount      Int      @default(1)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, shopItemId])
}

model Audit {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId   String?
  userId    String?
  type      String 
  meta      Json?
  createdAt DateTime @default(now())
}

model Bank {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @unique @db.ObjectId
  balance   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model IncomeConfig {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId        String
  commandKey     String   
  minPay         Int
  maxPay         Int
  cooldown       Int      
  successPct     Int?     @default(100)
  failPenaltyPct Int?     @default(50)
  createdAt      DateTime @default(now())

  @@unique([guildId, commandKey])
}

model GuildConfig {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  guildId       String   @unique
  currencyName  String   @default("Coins")
  currencyEmoji String   @default("ðŸª™")
  startMoney    Int      @default(1000)
  transferTax   Int      @default(0)
  incomeTax     Int      @default(0)
  bankLimit     Int?     @default(1000000)
  interestRate  Int      @default(0)
  prefix        String   @default("!")
  
  // Configs
  robSuccessPct  Int      @default(60)
  robFinePct     Int      @default(20)
  robCooldown    Int      @default(300)
  robImmuneRoles String[] @default([])
  
  minBet         Int      @default(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}