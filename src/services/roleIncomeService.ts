import prisma from "../utils/prisma";import { ensureBankForUser } from "./bankService";export async function setRoleIncome(guildId: string, roleId: string, amount: number, cooldownSeconds: number = 86400) {    return await prisma.roleIncome.upsert({        where: {            guildId_roleId: {                guildId,                roleId            }        },        update: {            amount,            cooldown: cooldownSeconds        },        create: {            guildId,            roleId,            amount,            cooldown: cooldownSeconds        }    });}export async function getRoleIncomes(guildId: string) {    return await prisma.roleIncome.findMany({ where: { guildId } });}export async function claimRoleIncome(discordId: string, guildId: string, roleIds: string[]) {    const user = await prisma.user.findUnique({ where: { discordId_guildId: { discordId, guildId } } });    if (!user) throw new Error("User profile not found.");    const eligibleIncomes = await prisma.roleIncome.findMany({        where: {            guildId,            roleId: { in: roleIds }        }    });    if (eligibleIncomes.length === 0) {        return { totalClaimed: 0, details: [] };    }    const results = [];    let totalPayout = 0;    for (const income of eligibleIncomes) {        const claim = await prisma.roleIncomeClaim.findUnique({            where: {                userId_roleIncomeId: {                    userId: user.id,                    roleIncomeId: income.id                }            }        });        const now = new Date();        if (claim) {            const nextClaim = new Date(claim.claimedAt.getTime() + income.cooldown * 1000);            if (now < nextClaim) {                continue;            }        }        await prisma.$transaction([            prisma.bank.update({                where: { userId: user.id },                data: { balance: { increment: income.amount } }            }),            prisma.roleIncomeClaim.upsert({                where: {                    userId_roleIncomeId: {                        userId: user.id,                        roleIncomeId: income.id                    }                },                update: { claimedAt: now },                create: {                    userId: user.id,                    roleIncomeId: income.id,                    claimedAt: now                }            })        ]);        totalPayout += income.amount;        results.push({ roleId: income.roleId, amount: income.amount });    }    return { totalClaimed: totalPayout, details: results };}