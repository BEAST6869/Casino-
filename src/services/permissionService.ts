import prisma from "../utils/prisma";import { Message, GuildMember } from "discord.js";import { getGuildConfig } from "./guildConfigService";export const BOT_OWNER_ID = "1288340046449086567";export async function checkCommandPermission(message: Message, commandName: string): Promise<{ allowed: boolean; reason?: string }> {    if (!message.guild || !message.member) return { allowed: true };    const guildId = message.guild.id;    const userId = message.author.id;    const channelId = message.channel.id;    const member = message.member;    if (userId === BOT_OWNER_ID) return { allowed: true };    if (userId === message.guild.ownerId) return { allowed: true };    if (member.permissions.has("Administrator")) return { allowed: true };    const config = await getGuildConfig(guildId);    const isBotCommander =        config.botCommanderUsers.includes(userId) ||        member.roles.cache.some(r => config.botCommanderRoles.includes(r.id));    const userDb = await prisma.user.findUnique({        where: { discordId_guildId: { discordId: userId, guildId } },        select: { isCasinoAdmin: true }    });    const isCasinoAdmin = userDb?.isCasinoAdmin ?? false;    if (isCasinoAdmin) return { allowed: true };    if (isBotCommander) {        if (commandName === "perms" || commandName === "permissions" || commandName === "bot-commander" || commandName === "bot-cmd") {            return { allowed: false, reason: "Bot Commanders cannot manage high-level permissions." };        }        return { allowed: true };    }    const permissions = await prisma.commandPermission.findMany({        where: {            guildId,            command: commandName,            OR: [                { targetType: "USER", targetId: userId },                { targetType: "ROLE", targetId: { in: member.roles.cache.map(r => r.id) } },                { targetType: "CHANNEL", targetId: channelId }            ]        }    });    const userAllow = permissions.some(p => p.targetType === "USER" && p.targetId === userId && p.action === "ALLOW");    const roleAllow = permissions.some(p => p.targetType === "ROLE" && member.roles.cache.has(p.targetId) && p.action === "ALLOW");    if (userAllow || roleAllow) return { allowed: true };    const channelAllow = permissions.some(p => p.targetType === "CHANNEL" && p.targetId === channelId && p.action === "ALLOW");    if (channelAllow) return { allowed: true };    const channelDeny = permissions.some(p => p.targetType === "CHANNEL" && p.targetId === channelId && p.action === "DENY");    if (channelDeny) return { allowed: false, reason: "Command disabled in this channel." };    if (config.disabledCommands.includes(commandName)) {        return { allowed: false, reason: "Command is globally disabled." };    }    if (config.casinoChannels.length > 0) {        if (!config.casinoChannels.includes(channelId)) {            const channelAllow = permissions.some(p => p.targetType === "CHANNEL" && p.targetId === channelId && p.action === "ALLOW");            if (!channelAllow) {                return { allowed: false, reason: "This channel is not a designated Casino Channel." };            }        }    }    return { allowed: true };}