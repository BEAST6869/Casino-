import {  Message,  EmbedBuilder,  Colors,  ActionRowBuilder,  ButtonBuilder,  ButtonStyle,  ComponentType} from "discord.js";import prisma from "../../utils/prisma";import { getGuildConfig } from "../../services/guildConfigService";import { fmtCurrency, fmtAmount } from "../../utils/format";import { emojiInline } from "../../utils/emojiRegistry";export async function handleLeaderboard(message: Message, args: string[]) {  const config = await getGuildConfig(message.guildId!);  const emoji = config.currencyEmoji;  const eGraphRaw = emojiInline("graph", message.guild) || "üìà";  const eWalletRaw = emojiInline("wallet", message.guild) || "üëõ";  const eMedal1 = emojiInline("medal1", message.guild) || "ü•á";  const eMedal2 = emojiInline("medal2", message.guild) || "ü•à";  const eMedal3 = emojiInline("medal3", message.guild) || "ü•â";  const parseBtnEmoji = (raw: string) => raw.match(/:(\d+)>/)?.[1] ?? (raw.match(/^\d+$/) ? raw : raw);  const btnGraph = parseBtnEmoji(eGraphRaw);  const btnWallet = parseBtnEmoji(eWalletRaw);  let initialType = "net";  if (args[0]?.toLowerCase() === "cash") initialType = "cash";  if (args[0]?.toLowerCase() === "level" || args[0]?.toLowerCase() === "xp") initialType = "level";  let currentType = initialType;  const users = await prisma.user.findMany({
    where: { guildId: message.guildId! },    include: { wallet: true, bank: true },  });  const getSorted = (t: string) => {    return [...users].sort((a, b) => {       if (t === "level") {        if (b.level !== a.level) return b.level - a.level;        return b.xp - a.xp;      }      const netA = (a.wallet?.balance ?? 0) + (t === "net" ? (a.bank?.balance ?? 0) : 0);      const netB = (b.wallet?.balance ?? 0) + (t === "net" ? (b.bank?.balance ?? 0) : 0);      return netB - netA;    });  };  const getEmbedData = (t: string, sortedUsers: any[]) => {    const top10 = sortedUsers.slice(0, 10);    const desc = top10.map((u, i) => {      let valStr = "";      if (t === "level") {        valStr = `Level ${u.level} (${fmtAmount(u.xp)} XP)`;      } else {        const val = (u.wallet?.balance ?? 0) + (t === "net" ? (u.bank?.balance ?? 0) : 0);        valStr = fmtCurrency(val, emoji);      }      let rankDisplay = `**${i + 1}.**`;      if (i === 0) rankDisplay = eMedal1;      if (i === 1) rankDisplay = eMedal2;      if (i === 2) rankDisplay = eMedal3;      return `${rankDisplay} **${u.username}** ‚Äî ${valStr}`;    }).join("\n");    let title = "";    if (t === "net") title = `${eGraphRaw} Net Worth Leaderboard`;    else if (t === "cash") title = `${eWalletRaw} Cash Leaderboard`;    else title = `‚≠ê Level Leaderboard`;    return { title, desc, topUsers: top10 };   };  const initialSorted = getSorted(currentType);  const { title, desc } = getEmbedData(currentType, initialSorted);  const embed = new EmbedBuilder()    .setTitle(title)    .setColor(Colors.Gold)    .setDescription(desc || "No users found.")    .setFooter({ text: "Top 10 Leaders" });  const getButtons = (activeType: string) => {    const bNet = new ButtonBuilder().setCustomId("lb_net").setLabel("Net Worth").setStyle(activeType === "net" ? ButtonStyle.Primary : ButtonStyle.Secondary);    const bCash = new ButtonBuilder().setCustomId("lb_cash").setLabel("Cash Only").setStyle(activeType === "cash" ? ButtonStyle.Primary : ButtonStyle.Secondary);    const bLevel = new ButtonBuilder().setCustomId("lb_level").setLabel("Levels").setStyle(activeType === "level" ? ButtonStyle.Primary : ButtonStyle.Secondary);    try { bNet.setEmoji(btnGraph); } catch { bNet.setEmoji("üìà"); }    try { bCash.setEmoji(btnWallet); } catch { bCash.setEmoji("üëõ"); }    try { bLevel.setEmoji("‚≠ê"); } catch { }    return new ActionRowBuilder<ButtonBuilder>().addComponents(bNet, bCash, bLevel);  };  const sent = await message.reply({ embeds: [embed], components: [getButtons(currentType)] });  const collector = sent.createMessageComponentCollector({ componentType: ComponentType.Button, time: 60000 });  collector.on("collect", async (i) => {    if (i.customId === "lb_net") currentType = "net";    if (i.customId === "lb_cash") currentType = "cash";    if (i.customId === "lb_level") currentType = "level";    const newSorted = getSorted(currentType);    const { title: newTitle, desc: newDesc } = getEmbedData(currentType, newSorted);    embed.setTitle(newTitle).setDescription(newDesc);    await i.update({ embeds: [embed], components: [getButtons(currentType)] });  });  collector.on("end", () => {    try {      const disabledRow = getButtons(currentType);      disabledRow.components.forEach(c => c.setDisabled(true));      sent.edit({ components: [disabledRow] }).catch(() => { });    } catch { }  });}
