import { Message, PermissionsBitField } from "discord.js";import prisma from "../../utils/prisma";import { ensureUserAndWallet } from "../../services/walletService";import { ensureBankForUser } from "../../services/bankService";import { successEmbed, errorEmbed } from "../../utils/embed";import { fmtCurrency, parseSmartAmount } from "../../utils/format";import { logToChannel } from "../../utils/discordLogger";import { getGuildConfig } from "../../services/guildConfigService";import { canExecuteAdminCommand } from "../../utils/permissionUtils";export async function handleAddMoney(message: Message, args: string[]) {  if (!message.member || !(await canExecuteAdminCommand(message, message.member))) {    return message.reply({ embeds: [errorEmbed(message.author, "Access Denied", "You need Administrator or Bot Commander permissions.")] });  }  const mention = args[0];  const amountStr = args[1];   const targetId = args[0].replace(/[<@!>]/g, "");  const amount = parseSmartAmount(args[1]);   const typeArg = args[2]?.toLowerCase();  const targetType = typeArg === "bank" ? "bank" : "wallet";   if (isNaN(amount) || amount <= 0) {    return message.reply({ embeds: [errorEmbed(message.author, "Invalid Amount", "Usage: `!add-money @user <amount> [wallet/bank]`")] });  }  const discordId = mention.replace(/[<@!>]/g, "");  const target = await ensureUserAndWallet(discordId, message.guildId!, "Unknown");  const config = await getGuildConfig(message.guildId!);  const emoji = config.currencyEmoji;  if (targetType === "bank") {    const bank = await ensureBankForUser(target.id);    const [_, updatedBank] = await prisma.$transaction([      prisma.transaction.create({        data: {          walletId: target.wallet!.id,          amount,          type: "admin_add_bank",          meta: { by: message.author.id },          isEarned: false        }      }),      prisma.bank.update({        where: { id: bank.id },        data: { balance: { increment: amount } }      }),      prisma.audit.create({        data: {          guildId: message.guildId ?? undefined,          userId: target.id,          type: "admin_add",          meta: { amount, target: "bank", by: message.author.id }        }      })    ]);    await logToChannel(message.client, {      guild: message.guild!,      type: "ADMIN",      title: "Money Added (Bank)",      description: `**Admin:** ${message.author.tag} (${message.author.id})\n**Target:** <@${target.discordId}>\n**Amount:** +${fmtCurrency(amount, emoji)}\n**New Bank Balance:** ${fmtCurrency(updatedBank.balance, emoji)}`,      color: 0x00FF00    });    return message.reply({      embeds: [successEmbed(message.author, "Money Added", `Added **${fmtCurrency(amount, emoji)}** to ${mention}'s **Bank**.\nNew Balance: **${fmtCurrency(updatedBank.balance, emoji)}**`)]    });  } else {    const [_, updatedWallet] = await prisma.$transaction([      prisma.transaction.create({        data: {          walletId: target.wallet!.id,          amount,          type: "admin_add",          meta: { by: message.author.id },          isEarned: false        }      }),      prisma.wallet.update({        where: { id: target.wallet!.id },        data: { balance: { increment: amount } }      }),      prisma.audit.create({        data: {          guildId: message.guildId ?? undefined,          userId: target.id,           type: "admin_add",          meta: { amount, target: "wallet", by: message.author.id }        }      })    ]);    if (updatedWallet) {      await logToChannel(message.client, {        guild: message.guild!,        type: "ADMIN",        title: "Money Added (Wallet)",        description: `**Admin:** ${message.author.tag} (${message.author.id})\n**Target:** <@${target.discordId}>\n**Amount:** +${fmtCurrency(amount, emoji)}\n**New Wallet Balance:** ${fmtCurrency(updatedWallet.balance, emoji)}`,        color: 0x00FF00      });      return message.reply({        embeds: [successEmbed(message.author, "Money Added", `Added **${fmtCurrency(amount, emoji)}** to ${mention}'s **Wallet**.\nNew Balance: **${fmtCurrency(updatedWallet.balance, emoji)}**`)]      });    }  }}